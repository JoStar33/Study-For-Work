# 리액트 쿼리의 캐싱을 이해하기

## staleTime (유통 기한)

- 쿼리가 최신 상태에서 더 이상 최신이 아닌 상태로 전환하는 시간
- 쿼리는 모든 해당 컴포넌트가 언마운트되어 관찰자가 없는 상태가 되는 즉시 비활성 상태로 전환
- staleTime은 데이터가 "stale" 상태로 간주되는 기간을 지정
- 데이터가 "stale" 상태란, `이전 쿼리 결과가 캐시되어 있지만, 그 결과가 일정 시간 동안 업데이트되지 않은 상태`
- staleTime은 밀리초 단위로 설정되며, 기본값은 0
- staleTime이 `0보다 큰 값`으로 설정되면, `staleTime 이후에도 이전 캐시 결과를 사용`할 수 있다.
  - 이렇게 하면 `네트워크 요청을 최소화`하고, 사용자 경험을 개선할 수 있다.
- staleTime이 `0`으로 설정되면, 데이터가 한 번 "stale" 상태가 되면 즉시 다시 쿼리를 수행하여 업데이트된 데이터를 가져오고 `받아오는 즉시 stale하다고 판단`해서 `캐싱 데이터와는 무관하게 계속 fetching`을 수행한다.
  - 그러므로 `staleTime을 지정하지 않고 사용한다면 React Query의 캐싱 기능을 활용할 수 없다.`
- fresh 상태일때는 페이지를 이동했다가 돌아왔을 경우에도 fetch가 일어나지 않는다.
  - 즉, 데이터가 한번 fetch 되고 `staleTIme이 지나지 않았다면` `unmount 후 mount가 발생해도 다시 fetch가 발생하지 않는다.`

### isLoading & isFetching

기존에 캐시된 데이터가 있느냐 에 따라 `isLoading`과 `isFetching`이 나뉜다.

- isLoading
  - 캐싱된 데이터조차 없이 처음 실행된 쿼리일 때 `true`
  - 캐싱된 데이터가 있을 경우 fetch를 하더라도 cacheTime 동안에는 항상 `false`
  - 어떤 데이터를 처음 가져올 때 사용
- isFetching
  - 캐싱 여부와 상관없이 비동기 함수가 처리되었으면 `true`
  - 어떤 데이터를 다시 가져와야 할 때 사용

## cacheTime (파기 시간)

- 비활성 상태의 쿼리가 캐시에서 제거되는 기간
- cacheTime은 `쿼리 결과를 캐시로 저장하는 기간`을 지정한다.
- 기본적으로, `React Query`는 `이전 쿼리 결과를 자동으로 캐시`하고, `이후 같은 쿼리가 호출될 때 이 캐시를 사용`한다.
- cacheTime은 밀리초 단위로 설정되며, 기본값은 5분(300000 밀리초)
- `cacheTime이 경과`하면 React Query는 `다시 쿼리를 수행`하여 `최신 데이터`를 가져온다.
- `쿼리 인스턴스가 unmount`되면 `데이터는 inactive 상태`로 변경되며, `캐시는 cacheTime 만큼 유지`된다.
  - 이걸 cacheTime 만큼 유지시키는 이유는 쿼리 인스턴스가 다시 마운트되면 데이터를 fetch 하는 동안 cacheTime이 지나지 않은 캐시 데이터를 보여주기 때문
- cacheTime이 지나면 `가비지 콜렉터`로 삭제가 된다.
